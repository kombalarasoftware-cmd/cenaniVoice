; ============================================================================
; Asterisk Dialplan - OpenAI Realtime Mini Voice Agent (v4 - Native 24kHz)
; ============================================================================
;
; chan_audiosocket ile 24kHz slin24 (0x13) kullanilir.
; Python Bridge 24kHz PCM16 passthrough yapar.
;
; Kontrol: asterisk -rx "core show version"
;          asterisk -rx "module show like audiosocket"
;
; Dosya: /etc/asterisk/extensions.conf
; MUTLU TELEKOM | 2026
; ============================================================================

[general]
static=yes
writeprotect=no
clearglobalvars=no


; ============================================================================
; Global Variables
; ============================================================================

[globals]
VOICEAI_APP=voiceai
; Bridge runs on Windows host, use host.docker.internal
AUDIOSOCKET_HOST=host.docker.internal
AUDIOSOCKET_PORT=9092
AUDIOSOCKET_ADDR=${AUDIOSOCKET_HOST}:${AUDIOSOCKET_PORT}
VOICEAI_CALLERID=491754571258
SIP_TRUNK=trunk


; ----------------------------------------------------------------------------
; AI AGENT - Native 24kHz
; ÖNEMLİ: Dial(AudioSocket/.../c(slin24)) kullanilir.
; ----------------------------------------------------------------------------
[ai-agent]

; Ana kullanım - 24kHz AudioSocket (native passthrough)
exten => 5001,1,Answer()
 ; JITTERBUFFER disabled: app_jitterbuffer not available in this build
 same => n,Set(UUID=${SHELL(cat /proc/sys/kernel/random/uuid | tr -d '\n')})
 same => n,Set(CDR(ai_session)=${UUID})
 same => n,Dial(AudioSocket/${AUDIOSOCKET_ADDR}/${UUID}/c(slin24))
 same => n,Hangup()

; Test - sabit UUID (debugging için)
exten => 5002,1,Answer()
 same => n,Dial(AudioSocket/${AUDIOSOCKET_ADDR}/00000000-0000-0000-0000-000000000001/c(slin24))
 same => n,Hangup()


; ----------------------------------------------------------------------------
; INBOUND - SIP Trunk'tan Gelen Çağrılar
; ----------------------------------------------------------------------------
[from-trunk]

exten => _X.,1,Answer()
 ; JITTERBUFFER disabled: app_jitterbuffer not available in this build
 same => n,Wait(1)
 same => n,Set(UUID=${SHELL(cat /proc/sys/kernel/random/uuid | tr -d '\n')})
 same => n,Set(CDR(ai_session)=${UUID})
 same => n,Set(CDR(caller_id)=${CALLERID(num)})
 same => n,NoOp(AI Agent: ${UUID} | Arayan: ${CALLERID(num)})
 same => n,Dial(AudioSocket/${AUDIOSOCKET_ADDR}/${UUID}/c(slin24))
 same => n,Hangup()


; ----------------------------------------------------------------------------
; IVR + AI AGENT
; ----------------------------------------------------------------------------
[ivr-main]

exten => s,1,Answer()
 same => n,Wait(1)
 same => n,Playback(welcome-message)
 same => n,Background(press-1-for-agent)
 same => n,WaitExten(5)

exten => 1,1,Set(UUID=${SHELL(cat /proc/sys/kernel/random/uuid | tr -d '\n')})
 same => n,Playback(please-wait)
 same => n,Dial(AudioSocket/${AUDIOSOCKET_ADDR}/${UUID}/c(slin24))
 same => n,Hangup()

exten => 2,1,Dial(PJSIP/operator1,30)
 same => n,Hangup()

exten => t,1,Goto(1,1)
exten => i,1,Playback(invalid)
 same => n,Goto(s,1)


; ----------------------------------------------------------------------------
; AI INBOUND - Gelen çağrılar için AI agent
; Test: channel originate PJSIP/xxx@trunk extension s@ai-inbound
; ----------------------------------------------------------------------------
[ai-inbound]

exten => s,1,Answer()
 ; JITTERBUFFER disabled: app_jitterbuffer not available in this build
 same => n,Wait(1)
 same => n,Set(UUID=${SHELL(cat /proc/sys/kernel/random/uuid | tr -d '\n')})
 same => n,Set(CDR(ai_session)=${UUID})
 same => n,NoOp(AI Inbound: UUID=${UUID}, Caller=${CALLERID(num)})
 same => n,Dial(AudioSocket/${AUDIOSOCKET_ADDR}/${UUID}/c(slin24))
 same => n,Hangup()

exten => _X.,1,Goto(s,1)


; ----------------------------------------------------------------------------
; OUTBOUND AI AGENT
; AMI/ARI ile tetiklenen dış arama
; ----------------------------------------------------------------------------
[ai-outbound]

exten => s,1,Answer()
 ; JITTERBUFFER disabled: app_jitterbuffer not available in this build
 same => n,Wait(1)
 same => n,Set(UUID=${SHELL(cat /proc/sys/kernel/random/uuid | tr -d '\n')})
 same => n,Set(CDR(ai_session)=${UUID})
 same => n,Set(CDR(called_number)=${CALLERID(dnid)})
 same => n,NoOp(AI Outbound: UUID=${UUID}, Called=${CALLERID(dnid)})
 same => n,Dial(AudioSocket/${AUDIOSOCKET_ADDR}/${UUID}/c(slin24))
 same => n,Hangup()


; ----------------------------------------------------------------------------
; ----------------------------------------------------------------------------
; ----------------------------------------------------------------------------
; VOICEAI OUTBOUND - Dış aramalar için
; ----------------------------------------------------------------------------
[voiceai-outbound]

exten => _+X.,1,NoOp(VoiceAI outbound to ${EXTEN})
 same => n,Set(CALLERID(num)=${VOICEAI_CALLERID})
 same => n,Set(CALLERID(name)=VoiceAI)
 same => n,Dial(PJSIP/${EXTEN:1}@${SIP_TRUNK},60,g)
 same => n,Hangup()

exten => _00X.,1,NoOp(VoiceAI international to ${EXTEN})
 same => n,Set(CALLERID(num)=${VOICEAI_CALLERID})
 same => n,Set(CALLERID(name)=VoiceAI)
 same => n,Dial(PJSIP/${EXTEN}@${SIP_TRUNK},60,g)
 same => n,Hangup()

exten => _X.,1,NoOp(VoiceAI outbound to ${EXTEN})
 same => n,Set(CALLERID(num)=${VOICEAI_CALLERID})
 same => n,Set(CALLERID(name)=VoiceAI)
 same => n,Dial(PJSIP/${EXTEN}@${SIP_TRUNK},60,g)
 same => n,Hangup()


; ----------------------------------------------------------------------------
; TRANSFER CONTEXT
; AI agent'tan operatöre transfer
; ----------------------------------------------------------------------------
[ai-transfer]

exten => destek,1,Dial(PJSIP/destek-queue,60)
 same => n,Hangup()

exten => satis,1,Dial(PJSIP/satis-queue,60)
 same => n,Hangup()

exten => teknik,1,Dial(PJSIP/teknik-queue,60)
 same => n,Hangup()


[voiceai-transfer]
exten => operator,1,NoOp(Transfer to operator)
 same => n,Set(CHANNEL(language)=tr)
 same => n,Dial(PJSIP/operator@trunk,60)
 same => n,Hangup()

exten => _X.,1,NoOp(Transfer to ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN}@trunk,60)
 same => n,Hangup()


; ============================================================================
; 8kHz FALLBACK (Eski Asterisk sürümleri için)
; AudioSocket() uygulaması 8kHz slin kullanir.
; Bu durumda Python tarafinda resampling gerekir.
; ============================================================================
[ai-agent-8k-fallback]

exten => 5099,1,Answer()
 same => n,Set(UUID=${SHELL(cat /proc/sys/kernel/random/uuid | tr -d '\n')})
 same => n,AudioSocket(${UUID},${AUDIOSOCKET_ADDR})
 same => n,Hangup()


; ============================================================================
; UTILITY EXTENSIONS
; ============================================================================
[voiceai-utils]

; Play hold music
exten => hold,1,MusicOnHold(default)

; Echo test
exten => echo,1,Echo()

; Time announcement
exten => time,1,SayUnixTime(,Europe/Istanbul,)
 same => n,Hangup()


; ============================================================================
; ERROR HANDLING
; ============================================================================
[voiceai-error]

exten => _X.,1,NoOp(Error handling)
 same => n,Playback(invalid)
 same => n,Hangup()

exten => i,1,NoOp(Invalid extension)
 same => n,Playback(invalid)
 same => n,Hangup()

exten => t,1,NoOp(Timeout)
 same => n,Hangup()

exten => h,1,NoOp(Hangup handler)


; ============================================================================
; NOTLAR:
; ============================================================================
;
; 1. CODEC FARKI (ÖNEMLİ):
;
;    ESKİ (v1 - resampling gerekli):
;    Dial(AudioSocket/127.0.0.1:9092/${UUID}/c(slin24))
;    → 8kHz PCM16 gönderir (0x10), Python'da 24kHz'e resample edilir
;
;    YENİ (v2 - native 24kHz, resampling yok):
;    Dial(AudioSocket/127.0.0.1:9092/${UUID}/c(slin24))
;    → 24kHz PCM16 gönderir (0x13), doğrudan OpenAI'ye iletilir
;
; 2. slin24 codec'i Asterisk 20+ gerektirir
;    Kontrol: asterisk -rx "core show codecs" | grep slin24
;
; 3. Bridge sunucusu farklı makinedeyse IP'yi değiştirin:
;    Dial(AudioSocket/192.168.1.100:9092/${UUID}/c(slin24))
;
; 4. Docker ortamında:
;    docker exec voiceai-asterisk asterisk -rx "core show version"
;    docker exec voiceai-asterisk asterisk -rx "dialplan reload"
;
; 5. Performans (50 eşzamanlı kanal):
;    - asterisk.conf → maxcalls = 100
;    - slin24 ile resampling olmadığı için CPU kullanımı düşer
;
; ============================================================================
