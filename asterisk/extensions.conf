; ============================================================================
; Asterisk Dialplan - VoiceAI Platform (v4 - Native 24kHz)
; ============================================================================
;
; Uses chan_audiosocket with 24kHz slin24 (0x13) codec.
; Python Bridge does 24kHz PCM16 passthrough (no resampling).
;
; Check: asterisk -rx "core show version"
;        asterisk -rx "module show like audiosocket"
;
; File: /etc/asterisk/extensions.conf
; SIP Provider: MUTLU TELEKOM | 2026
; ============================================================================

[general]
static=yes
writeprotect=no
clearglobalvars=no


; ============================================================================
; Global Variables
; ============================================================================

[globals]
VOICEAI_APP=voiceai
; Bridge runs on asterisk-bridge container in Docker network
AUDIOSOCKET_HOST=asterisk-bridge
AUDIOSOCKET_PORT=9092
AUDIOSOCKET_ADDR=${AUDIOSOCKET_HOST}:${AUDIOSOCKET_PORT}
VOICEAI_CALLERID=491632086421
SIP_TRUNK=trunk


; ----------------------------------------------------------------------------
; AI AGENT - Native 24kHz
; IMPORTANT: Uses Dial(AudioSocket/.../c(slin24))
; ----------------------------------------------------------------------------
[ai-agent]

; Main usage - 24kHz AudioSocket (native passthrough)
exten => 5001,1,Answer()
 ; JITTERBUFFER disabled: app_jitterbuffer not available in this build
 same => n,Set(UUID=${SHELL(cat /proc/sys/kernel/random/uuid | tr -d '\n')})
 same => n,Set(CDR(ai_session)=${UUID})
 same => n,Dial(AudioSocket/${AUDIOSOCKET_ADDR}/${UUID}/c(slin24))
 same => n,Hangup()

; Test - fixed UUID (for debugging)
exten => 5002,1,Answer()
 same => n,Dial(AudioSocket/${AUDIOSOCKET_ADDR}/00000000-0000-0000-0000-000000000001/c(slin24))
 same => n,Hangup()


; ----------------------------------------------------------------------------
; ULTRAVOX BRIDGE - Incoming SIP from Ultravox/Voximplant
; Ultravox sends SIP INVITE here, Asterisk routes to SIP trunk
; Flow: Ultravox AI -> SIP -> Asterisk -> SIP trunk -> Phone
; ----------------------------------------------------------------------------
[from-ultravox]

; Match any phone number and route through SIP trunk
; AMD runs on called channel AFTER answer, BEFORE bridging to Ultravox AI
exten => _+X.,1,NoOp(Ultravox bridge call to ${EXTEN})
 same => n,Set(CALLERID(num)=${VOICEAI_CALLERID})
 same => n,Set(CALLERID(name)=VoiceAI)
 same => n,Set(_ULTRAVOX_PHONE=${EXTEN})
 same => n,Dial(PJSIP/${EXTEN:1}@${SIP_TRUNK},120,gU(ultravox-amd-check,s,1))
 same => n,Hangup()

exten => _00X.,1,NoOp(Ultravox bridge international to ${EXTEN})
 same => n,Set(CALLERID(num)=${VOICEAI_CALLERID})
 same => n,Set(CALLERID(name)=VoiceAI)
 same => n,Set(_ULTRAVOX_PHONE=+${EXTEN:2})
 same => n,Dial(PJSIP/${EXTEN}@${SIP_TRUNK},120,gU(ultravox-amd-check,s,1))
 same => n,Hangup()

exten => _X.,1,NoOp(Ultravox bridge call to ${EXTEN})
 same => n,Set(CALLERID(num)=${VOICEAI_CALLERID})
 same => n,Set(CALLERID(name)=VoiceAI)
 same => n,Set(_ULTRAVOX_PHONE=+${EXTEN})
 same => n,Dial(PJSIP/${EXTEN}@${SIP_TRUNK},120,gU(ultravox-amd-check,s,1))
 same => n,Hangup()


; ----------------------------------------------------------------------------
; ULTRAVOX AMD CHECK - Subroutine for Dial() U() option
; Runs on the called channel (outbound leg) AFTER answer, BEFORE bridge.
; Analyzes audio from the remote party (person or voicemail).
; MACHINE/NOTSURE: notify backend + abort both channels.
; HUMAN: return and bridge to Ultravox AI.
; ----------------------------------------------------------------------------
[ultravox-amd-check]

exten => s,1,NoOp(Ultravox AMD check for ${ULTRAVOX_PHONE})
 same => n,AMD()
 same => n,NoOp(Ultravox AMD Result: ${AMDSTATUS} - ${AMDCAUSE})
 same => n,GotoIf($["${AMDSTATUS}" = "MACHINE"]?machine)
 same => n,GotoIf($["${AMDSTATUS}" = "NOTSURE"]?machine)
 ; HUMAN detected - return to Dial() and bridge with Ultravox AI
 same => n,Return()
 same => n(machine),NoOp(Ultravox AMD: ${AMDSTATUS} for ${ULTRAVOX_PHONE})
 same => n,System(curl -s -X POST http://backend:8000/api/v1/webhooks/amd-result -H "Content-Type: application/json" -d '{"phone":"${ULTRAVOX_PHONE}","status":"${AMDSTATUS}","cause":"${AMDCAUSE}","source":"ultravox"}' &)
 same => n,Set(GOSUB_RESULT=ABORT)
 same => n,Return()


; ----------------------------------------------------------------------------
; INBOUND - Incoming calls from SIP trunk
; ----------------------------------------------------------------------------
[from-trunk]

exten => _X.,1,Answer()
 ; JITTERBUFFER disabled: app_jitterbuffer not available in this build
 same => n,Wait(1)
 same => n,Set(UUID=${SHELL(cat /proc/sys/kernel/random/uuid | tr -d '\n')})
 same => n,Set(CDR(ai_session)=${UUID})
 same => n,Set(CDR(caller_id)=${CALLERID(num)})
 same => n,NoOp(AI Agent: ${UUID} | Caller: ${CALLERID(num)})
 same => n,Dial(AudioSocket/${AUDIOSOCKET_ADDR}/${UUID}/c(slin24))
 same => n,Hangup()


; ----------------------------------------------------------------------------
; IVR + AI AGENT
; ----------------------------------------------------------------------------
[ivr-main]

exten => s,1,Answer()
 same => n,Wait(1)
 same => n,Playback(welcome-message)
 same => n,Background(press-1-for-agent)
 same => n,WaitExten(5)

exten => 1,1,Set(UUID=${SHELL(cat /proc/sys/kernel/random/uuid | tr -d '\n')})
 same => n,Playback(please-wait)
 same => n,Dial(AudioSocket/${AUDIOSOCKET_ADDR}/${UUID}/c(slin24))
 same => n,Hangup()

exten => 2,1,Dial(PJSIP/operator1,30)
 same => n,Hangup()

exten => t,1,Goto(1,1)
exten => i,1,Playback(invalid)
 same => n,Goto(s,1)


; ----------------------------------------------------------------------------
; AI INBOUND - AI agent for incoming calls
; Test: channel originate PJSIP/xxx@trunk extension s@ai-inbound
; ----------------------------------------------------------------------------
[ai-inbound]

exten => s,1,Answer()
 ; JITTERBUFFER disabled: app_jitterbuffer not available in this build
 same => n,Wait(1)
 same => n,Set(UUID=${SHELL(cat /proc/sys/kernel/random/uuid | tr -d '\n')})
 same => n,Set(CDR(ai_session)=${UUID})
 same => n,NoOp(AI Inbound: UUID=${UUID}, Caller=${CALLERID(num)})
 same => n,Dial(AudioSocket/${AUDIOSOCKET_ADDR}/${UUID}/c(slin24))
 same => n,Hangup()

exten => _X.,1,Goto(s,1)


; ----------------------------------------------------------------------------
; OUTBOUND AI AGENT
; Triggered via AMI/ARI for outbound calls
; AMD (Answering Machine Detection) -> MACHINE: notify backend and hangup
; ----------------------------------------------------------------------------
[ai-outbound]

; Outbound calls: VOICEAI_UUID is pre-generated by backend and stored in Redis
; with agent settings. If not set (manual dial), generate a random UUID.
exten => s,1,Answer()
 ; JITTERBUFFER disabled: app_jitterbuffer not available in this build
 same => n,ExecIf($["${VOICEAI_UUID}" = ""]?Set(VOICEAI_UUID=${SHELL(cat /proc/sys/kernel/random/uuid | tr -d '\n')}))
 same => n,Set(CDR(ai_session)=${VOICEAI_UUID})
 same => n,Set(CDR(called_number)=${CALLERID(dnid)})
 ;
 ; --- AMD Detection ---
 ; AMD() listens to initial audio and sets AMDSTATUS (HUMAN/MACHINE/NOTSURE)
 ; and AMDCAUSE (why it decided)
 ; NOTE: No Wait() before AMD â€” AMD immediately starts listening.
 ; AMD will return as soon as it makes a decision (typically 1-2s for HUMAN).
 same => n,AMD()
 same => n,NoOp(AMD Result: ${AMDSTATUS} - ${AMDCAUSE})
 same => n,Set(CDR(amd_result)=${AMDSTATUS})
 ;
 ; If answering machine detected, notify backend and hangup
 same => n,GotoIf($["${AMDSTATUS}" = "MACHINE"]?amd_machine,s,1)
 ;
 ; If NOTSURE, also treat as machine (voicemail safety)
 same => n,GotoIf($["${AMDSTATUS}" = "NOTSURE"]?amd_machine,s,1)
 ;
 ; HUMAN -> proceed with AI agent
 same => n,NoOp(AI Outbound: UUID=${VOICEAI_UUID}, Agent=${VOICEAI_AGENT_ID}, Called=${CALLERID(dnid)}, AMD=${AMDSTATUS})
 same => n,Dial(AudioSocket/${AUDIOSOCKET_ADDR}/${VOICEAI_UUID}/c(slin24))
 same => n,Hangup()


; AMD Machine/NOTSURE Detected - notify backend & hangup
[amd_machine]
exten => s,1,NoOp(AMD Machine Detected: UUID=${VOICEAI_UUID}, Status=${AMDSTATUS}, Cause=${AMDCAUSE})
 same => n,System(curl -s -X POST http://backend:8000/api/v1/webhooks/amd-result -H "Content-Type: application/json" -d '{"uuid":"${VOICEAI_UUID}","status":"${AMDSTATUS}","cause":"${AMDCAUSE}"}' &)
 same => n,Hangup()


; ----------------------------------------------------------------------------
; VOICEAI OUTBOUND - Outbound calls
; ----------------------------------------------------------------------------
[voiceai-outbound]

exten => _+X.,1,NoOp(VoiceAI outbound to ${EXTEN})
 same => n,Set(CALLERID(num)=${VOICEAI_CALLERID})
 same => n,Set(CALLERID(name)=VoiceAI)
 same => n,Dial(PJSIP/${EXTEN:1}@${SIP_TRUNK},60,g)
 same => n,Hangup()

exten => _00X.,1,NoOp(VoiceAI international to ${EXTEN})
 same => n,Set(CALLERID(num)=${VOICEAI_CALLERID})
 same => n,Set(CALLERID(name)=VoiceAI)
 same => n,Dial(PJSIP/${EXTEN}@${SIP_TRUNK},60,g)
 same => n,Hangup()

exten => _X.,1,NoOp(VoiceAI outbound to ${EXTEN})
 same => n,Set(CALLERID(num)=${VOICEAI_CALLERID})
 same => n,Set(CALLERID(name)=VoiceAI)
 same => n,Dial(PJSIP/${EXTEN}@${SIP_TRUNK},60,g)
 same => n,Hangup()


; ----------------------------------------------------------------------------
; TRANSFER CONTEXT
; Transfer from AI agent to human operator
; ----------------------------------------------------------------------------
[ai-transfer]

exten => support,1,Dial(PJSIP/support-queue,60)
 same => n,Hangup()

exten => sales,1,Dial(PJSIP/sales-queue,60)
 same => n,Hangup()

exten => technical,1,Dial(PJSIP/technical-queue,60)
 same => n,Hangup()


[voiceai-transfer]
exten => operator,1,NoOp(Transfer to operator)
 same => n,Dial(PJSIP/operator@trunk,60)
 same => n,Hangup()

exten => _X.,1,NoOp(Transfer to ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN}@trunk,60)
 same => n,Hangup()


; ============================================================================
; 8kHz FALLBACK (For older Asterisk versions)
; AudioSocket() uses 8kHz slin.
; In this case, Python-side resampling is required.
; ============================================================================
[ai-agent-8k-fallback]

exten => 5099,1,Answer()
 same => n,Set(UUID=${SHELL(cat /proc/sys/kernel/random/uuid | tr -d '\n')})
 same => n,AudioSocket(${UUID},${AUDIOSOCKET_ADDR})
 same => n,Hangup()


; ============================================================================
; UTILITY EXTENSIONS
; ============================================================================
[voiceai-utils]

; Play hold music
exten => hold,1,MusicOnHold(default)

; Echo test
exten => echo,1,Echo()

; Time announcement
exten => time,1,SayUnixTime(,Europe/Istanbul,)
 same => n,Hangup()


; ============================================================================
; ERROR HANDLING
; ============================================================================
[voiceai-error]

exten => _X.,1,NoOp(Error handling)
 same => n,Playback(invalid)
 same => n,Hangup()

exten => i,1,NoOp(Invalid extension)
 same => n,Playback(invalid)
 same => n,Hangup()

exten => t,1,NoOp(Timeout)
 same => n,Hangup()

exten => h,1,NoOp(Hangup handler)


; ============================================================================
; NOTES:
; ============================================================================
;
; 1. CODEC DIFFERENCE (IMPORTANT):
;
;    OLD (v1 - resampling required):
;    Dial(AudioSocket/127.0.0.1:9092/${UUID}/c(slin24))
;    -> Sends 8kHz PCM16 (0x10), resampled to 24kHz in Python
;
;    NEW (v2 - native 24kHz, no resampling):
;    Dial(AudioSocket/127.0.0.1:9092/${UUID}/c(slin24))
;    -> Sends 24kHz PCM16 (0x13), forwarded directly to OpenAI
;
; 2. slin24 codec requires Asterisk 20+
;    Check: asterisk -rx "core show codecs" | grep slin24
;
; 3. If bridge runs on a different machine, change the IP:
;    Dial(AudioSocket/192.168.1.100:9092/${UUID}/c(slin24))
;
; 4. Docker environment:
;    docker exec voiceai-asterisk asterisk -rx "core show version"
;    docker exec voiceai-asterisk asterisk -rx "dialplan reload"
;
; 5. Performance (50 concurrent channels):
;    - asterisk.conf -> maxcalls = 100
;    - slin24 eliminates resampling, reducing CPU usage
;
; ============================================================================
