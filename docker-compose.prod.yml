# ===========================================
# VoiceAI Platform - Production Override
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ===========================================

services:
  # ===========================================
  # Frontend - Production mode
  # ===========================================
  frontend:
    environment:
      # NOTE: NEXT_PUBLIC_* vars are baked at build time in Next.js.
      # api.ts defaults to '' (relative URLs) which works with nginx proxy.
      # These are kept for documentation/SSR purposes only.
      - NEXT_PUBLIC_API_URL=https://one.speakmaxi.com
      - NEXT_PUBLIC_WS_URL=wss://one.speakmaxi.com
      - NODE_ENV=production
    ports: !reset []  # Remove direct host port - nginx will proxy
    restart: unless-stopped

  # ===========================================
  # Backend - Production mode (no reload, no volume mount)
  # ===========================================
  backend:
    ports: !reset []  # Remove direct host port - nginx will proxy
    volumes: !reset []  # No dev volume mount in production
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
    restart: unless-stopped

  # ===========================================
  # Celery Worker - Production
  # ===========================================
  celery-worker:
    volumes: !reset []
    restart: unless-stopped

  # ===========================================
  # Celery Beat - Production
  # ===========================================
  celery-beat:
    volumes: !reset []
    restart: unless-stopped

  # ===========================================
  # Asterisk Bridge - Production
  # ===========================================
  asterisk-bridge:
    ports: !reset []  # Internal only - asterisk connects via Docker network
    volumes: !reset []
    restart: unless-stopped

  # ===========================================
  # Asterisk - Production (close ARI, keep SIP/RTP)
  # ===========================================
  asterisk:
    ports: !reset
      - "5060:5060/udp"   # SIP signaling (required for trunk)
      - "5060:5060/tcp"
      - "5061:5061/tcp"   # SIP TLS
      - "10000-10100:10000-10100/udp"  # RTP media
      # 8088 (ARI) removed - backend connects via Docker network

  # ===========================================
  # MinIO - Production (console via nginx proxy)
  # ===========================================
  minio:
    ports: !reset []  # Internal only - nginx proxies via m.speakmaxi.com

  # ===========================================
  # Nginx Reverse Proxy with SSL
  # ===========================================
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - certbot-webroot:/var/www/certbot:ro
    depends_on:
      - frontend
      - backend
    networks:
      - voiceai-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

  # ===========================================
  # Certbot (SSL certificate auto-renewal)
  # ===========================================
  certbot:
    image: certbot/certbot
    volumes:
      - ./nginx/ssl:/etc/letsencrypt
      - certbot-webroot:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - voiceai-network
    restart: unless-stopped

  # ===========================================
  # pgAdmin - PostgreSQL Web UI
  # ===========================================
  pgadmin:
    build:
      context: ./pgadmin
      dockerfile: Dockerfile
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@speakmaxi.com
      - PGADMIN_DEFAULT_PASSWORD=Speakmaxi2026!
      - PGADMIN_CONFIG_PROXY_X_FOR_COUNT=1
      - PGADMIN_CONFIG_PROXY_X_PROTO_COUNT=1
      - PGADMIN_CONFIG_PROXY_X_HOST_COUNT=1
      - PGADMIN_SERVER_JSON_FILE=/pgadmin4/servers.json
    volumes:
      - pgadmin-data:/var/lib/pgadmin
      - ./pgadmin/servers.json:/pgadmin4/servers.json:ro
    depends_on:
      - postgres
    networks:
      - voiceai-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # ===========================================
  # Flower - Celery Monitoring Web UI
  # ===========================================
  flower:
    image: mher/flower:2.0
    environment:
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-changeme}@redis:6379/0
      - FLOWER_BASIC_AUTH=admin:${FLOWER_PASSWORD:-Speakmaxi2026!}
      - FLOWER_URL_PREFIX=
      - FLOWER_PORT=5555
    depends_on:
      - redis
      - celery-worker
    networks:
      - voiceai-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

  # ===========================================
  # Portainer - Docker Web UI
  # ===========================================
  portainer:
    image: portainer/portainer-ce:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer-data:/data
    networks:
      - voiceai-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

volumes:
  certbot-webroot:
  portainer-data:
  pgadmin-data:
